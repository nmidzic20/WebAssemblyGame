<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Game</title>
    <meta charset="UTF-8" />
    <style>
      body {
        margin: 0;
        overflow-x: hidden;
      }

      #main-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: row;
        position: relative;
      }

      #shape-container {
        display: none;
        justify-content: center;
        align-items: center;
      }

      #username-container {
        display: none;
        justify-content: center;
        align-items: center;
        position: absolute;
        z-index: 1;
      }

      #start-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
        z-index: 1;
      }

      #start-button {
        display: none;
        padding: 10px 20px;
        font-size: 18px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #start-button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <header>
      <div>#nav#</div>
      <h1>Game</h1>
    </header>
    <main>
      <div id="start-container">
        <button id="start-button">START</button>
      </div>
      <div id="username-container">
        <input
          type="text"
          id="username-input"
          placeholder="Enter your username"
        />
        <button id="submit-button">Submit</button>
        <div id="restart-container">
          <button id="restart-button">Restart</button>
        </div>
      </div>
      <div id="main-wrapper">
        <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
        <div id="shape-container"></div>
      </div>
    </main>
    <footer></footer>
    <script type="text/javascript">
      var Module = {};

      let usernameInput = document.getElementById("username-input");
      let submitButton = document.getElementById("submit-button");
      let startButton = document.getElementById("start-button");
      let restartButton = document.getElementById("restart-button");
      let shapeContainer = document.getElementById("shape-container");

      submitButton.addEventListener("click", function () {
        let username = usernameInput.value;
        let score = Module.playerScore;

        fetch("/save_player", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            username: username,
            score: score,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data.message);
            usernameInput.value = "";
            Module.gameDataStored = true;
            usernameInput.style.display = "none";
            submitButton.style.display = "none";
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      });

      usernameInput.addEventListener("keydown", function (event) {
        if (event.key == "Backspace")
          usernameInput.value = usernameInput.value.slice(0, -1);
        else if (event.key.length === 1) usernameInput.value += event.key;
      });

      startButton.addEventListener("click", function () {
        Module.startGame = true;
        document.getElementById("start-container").style.display = "none";
      });

      restartButton.addEventListener("click", function () {
        Module.ccall("restart_game", "void", ["number"], [Module.context]);
        document.getElementById("username-container").style.display = "none";
      });

      if (!Module.canvas) {
        Module.canvas = document.getElementById("canvas");
      }
      loadIndexJS();

      function loadIndexJS() {
        let existingScript = document.querySelector("script[src='/index.js']");
        if (existingScript) {
          existingScript.remove();
        }

        let script = document.createElement("script");
        script.src = "/index.js";
        document.head.appendChild(script);
      }

      Module.gameDataStored = false;

      Module.onGameLoaded = function (width, height) {
        let startContainer = document.getElementById("start-container");
        let usernameContainer = document.getElementById("username-container");
        startContainer.style.width = width + "px";
        startContainer.style.height = height + "px";
        usernameContainer.style.width = width + "px";
        usernameContainer.style.height = height + "px";

        startButton.style.display = "block";
        shapeContainer.style.display = "flex";
      };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r127/three.min.js"></script>
    <script type="module">
      function setupShapes(container) {
        const scene = new THREE.Scene();
        scene.background = new THREE.Color("#0d0c18");

        const geometryCube = new THREE.BoxGeometry(10, 10, 10);
        geometryCube.center();
        const materialCube = new THREE.MeshBasicMaterial({ color: 0xffff00 }); //new THREE.MeshNormalMaterial({
        //side: THREE.DoubleSide,
        //});
        const cube = new THREE.Mesh(geometryCube, materialCube);
        scene.add(cube);

        const geometryCone = new THREE.ConeGeometry(5, 20, 32);
        const materialCone = new THREE.MeshBasicMaterial({ color: 0xffff00 }); //new THREE.MeshNormalMaterial({
        //side: THREE.DoubleSide,
        //});
        const cone = new THREE.Mesh(geometryCone, materialCone);
        cone.position.x = 15;
        scene.add(cone);

        const camera = new THREE.PerspectiveCamera();
        camera.position.set(10, 10, 60);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        container.appendChild(renderer.domElement);
        renderer.setSize(400, 600);
        renderer.setPixelRatio(window.devicePixelRatio);

        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        const originalCubeColor = cube.material.color.getHex();
        const originalConeColor = cone.material.color.getHex();

        const onMouseMove = (event) => {
          const rect = renderer.domElement.getBoundingClientRect();
          mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

          raycaster.setFromCamera(mouse, camera);

          const intersects = raycaster.intersectObjects([cube, cone]);

          if (intersects.length > 0) {
            const hoveredObject = intersects[0].object;

            hoveredObject.material.color.setHex(0xff0000);
          } else {
            cube.material.color.setHex(originalCubeColor);
            cone.material.color.setHex(originalConeColor);
          }
        };

        const onMouseOut = () => {
          cube.material.color.setHex(originalCubeColor);
          cone.material.color.setHex(originalConeColor);
        };

        const onMouseClick = (event) => {
          const rect = renderer.domElement.getBoundingClientRect();
          mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

          raycaster.setFromCamera(mouse, camera);

          const intersects = raycaster.intersectObjects([cube, cone]);

          if (intersects.length > 0) {
            if (intersects[0].object === cube) {
              console.log("Cube was clicked");
            } else if (intersects[0].object === cone) {
              console.log("Cone was clicked");
            }
          }
        };

        renderer.domElement.addEventListener("click", onMouseClick);
        renderer.domElement.addEventListener("mousemove", onMouseMove);
        renderer.domElement.addEventListener("mouseout", onMouseOut);

        const render = () => {
          requestAnimationFrame(render);

          cube.rotation.y += 0.01;
          cone.rotation.x -= 0.01;
          cone.rotation.y -= 0.01;

          renderer.render(scene, camera);
        };

        render();
      }

      window.addEventListener("load", () => {
        if (shapeContainer) {
          setupShapes(shapeContainer);
        }
      });
    </script>
  </body>
</html>
