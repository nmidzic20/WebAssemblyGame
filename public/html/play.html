<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Game</title>
    <meta charset="UTF-8" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }

      #username-container {
        display: none;
        justify-content: center;
        align-items: center;
        position: absolute;
      }

      #start-container {
        display: flex;
        justify-content: center;
        align-items: center;
        position: absolute;
      }

      #start-button {
        display: none;
        padding: 10px 20px;
        font-size: 18px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      #start-button:hover {
        background-color: #0056b3;
      }
    </style>
  </head>
  <body>
    <header>
      <div>#nav#</div>
      <h1>Game</h1>
    </header>
    <main>
      <div id="start-container">
        <button id="start-button">START</button>
      </div>
      <div id="username-container">
        <input
          type="text"
          id="username-input"
          placeholder="Enter your username"
        />
        <button id="submit-button">Submit</button>
        <div id="restart-container">
          <button id="restart-button">Restart</button>
        </div>
      </div>
      <div id="shape-container"></div>

      <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    </main>
    <footer></footer>
    <script type="text/javascript">
      var Module = {};

      var usernameInput = document.getElementById("username-input");
      var submitButton = document.getElementById("submit-button");
      var startButton = document.getElementById("start-button");
      var restartButton = document.getElementById("restart-button");

      submitButton.addEventListener("click", function () {
        var username = usernameInput.value;
        var score = Module.playerScore;

        fetch("/save_player", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            username: username,
            score: score,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log(data.message);
            usernameInput.value = "";
            Module.gameDataStored = true;
            usernameInput.style.display = "none";
            submitButton.style.display = "none";
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      });

      usernameInput.addEventListener("keydown", function (event) {
        if (event.key == "Backspace")
          usernameInput.value = usernameInput.value.slice(0, -1);
        else if (event.key.length === 1) usernameInput.value += event.key;
      });

      startButton.addEventListener("click", function () {
        Module.startGame = true;
        document.getElementById("start-container").style.display = "none";
      });

      restartButton.addEventListener("click", function () {
        Module.ccall("restart_game", "void", ["number"], [Module.context]);
        document.getElementById("username-container").style.display = "none";
      });

      if (!Module.canvas) {
        Module.canvas = document.getElementById("canvas");
      }
      loadIndexJS();

      function loadIndexJS() {
        var existingScript = document.querySelector("script[src='/index.js']");
        if (existingScript) {
          existingScript.remove();
        }

        var script = document.createElement("script");
        script.src = "/index.js";
        document.head.appendChild(script);
      }

      Module.gameDataStored = false;

      Module.onGameLoaded = function (width, height) {
        let startContainer = document.getElementById("start-container");
        let usernameContainer = document.getElementById("username-container");
        startContainer.style.width = width + "px";
        startContainer.style.height = height + "px";
        usernameContainer.style.width = width + "px";
        usernameContainer.style.height = height + "px";
        startButton.style.display = "block";
      };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r127/three.min.js"></script>
    <script type="module">
      function setupShapes(container) {
        // Create a scene
        const scene = new THREE.Scene();
        scene.background = new THREE.Color("#0d0c18");
        // Create a cube
        const geometry = new THREE.BoxGeometry(10, 10, 10);
        geometry.center();
        const material = new THREE.MeshNormalMaterial({
          side: THREE.DoubleSide,
        });
        const cube = new THREE.Mesh(geometry, material);
        scene.add(cube);
        // Create a camera
        const camera = new THREE.PerspectiveCamera();
        camera.position.set(10, 10, 60);
        camera.lookAt(0, 0, 0);
        // Rendering
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        container.appendChild(renderer.domElement);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // Create an animation loop
        const render = () => {
          requestAnimationFrame(render);

          // Rotate the cube
          cube.rotation.y += 0.01;

          renderer.render(scene, camera);
        };

        render();
      }

      // Call the setupShapes function when the page is loaded
      window.addEventListener("load", () => {
        const shapeContainer = document.getElementById("shape-container");
        if (shapeContainer) {
          setupShapes(shapeContainer);
        }
      });
    </script>
  </body>
</html>
